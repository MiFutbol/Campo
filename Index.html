<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta name="viewport" id="viewport" content="width=device-width, user-scalable=no, minimum-scale=1, maximum-scale=1" />
    <title>Leaflet Tutorial</title>

    <!-- leaflet css  -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" /> 
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@v0.74.0/dist/L.Control.Locate.min.css" />      
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.74.4/dist/L.Control.Locate.min.css" />       
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">   

    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@v0.74.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>  
    <script src="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>L_NO_TOUCH = false;</script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 90vh;
        }
    </style>
</head>

<body>   
    <input hidden=true, type="button" id="btn_update" value="Actualizar viaje" onclick="actualizar_ruta()">
    <div style="text-align: left;", id="resumen"><small>Obteniendo posicion y ruta ...</small></div>
    <div style="text-align: left;", id="llegada"><small>Calculando hora llegada ...</small></div>
    <div  id="map"></div>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script>
    var Coche = L.icon
    ({
      iconUrl: 'Img/coche.png',
      iconSize: [30, 30]
    }) 

    var iconoLlegada = L.icon
    ({
      iconUrl: 'Img/iconoLlegada.png',
      iconSize: [30, 30]
    }) 

    var iconoFinalViaje = L.icon
    ({
      iconUrl: 'Img/final_viaje.png',
      iconSize: [30, 30]
    }) 

    var SinIconoSalida = new L.Icon
    ({
      iconUrl: 'Img/gps3.png',  
      iconSize: [0, 0],
    });

    const queryString = new URLSearchParams(window.location.search);  
    const lat_fin = queryString.get("lat_fin");    
    const lon_fin = queryString.get("lon_fin");    
    const lat_ini = queryString.get("lat_ini");    
    const lon_ini = queryString.get("lon_ini");   
    
    // Map initialization 
    var map = L.map('map', {minZoom: 10, maxZoom: 16}).setView([lat_ini, lon_ini], 13);              //Parte del mapa que se ve al activar, que es el punto de origen
    var mi_posicino_lat = lat_ini;
    var mi_posicino_lng = lon_ini;
    var Div_resumen = document.getElementById('resumen'); 
    var Div_llegada = document.getElementById('llegada');  
    var Div_btn = document.getElementById("btn_update");
    var timer;
    var timer_act;   
    var distancia;

L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);


var Mi_marca = new L.Marker([lat_ini, lon_ini], {icon: Coche}).addTo(map);
var Marca_campo = new L.Marker([lat_fin, lon_fin], {icon: iconoLlegada}).addTo(map);

function locate() 
{
  map.locate({watch: true, maxZoom: 16});                                                       //Localiza nuestra posicion actual

  function onLocationFound(e) 
   {
      Mi_marca.setLatLng([e.latlng.lat, e.latlng.lng]);
      map.panTo([e.latlng.lat, e.latlng.lng])     
      
      mi_posicino_lat = e.latlng.lat;
      mi_posicino_lng = e.latlng.lng;                    
   }
  map.on('locationfound', onLocationFound);
}


var routingControl = L.Routing.control({
    waypoints: [
        L.latLng(lat_ini, lon_ini),   //Oringen 
        L.latLng(lat_fin, lon_fin)    //Destino
    ],
    createMarker: function() { return null; },
    routeWhileDragging: true,
    draggableWaypoints: false,
    reverseWaypoints: false,
    fitSelectedRoutes: true,
    addWaypoints: true,
    show : false
}).addTo(map);

L.Routing.errorControl(routingControl).addTo(map);

setInterval(locate, 1000);

setInterval(function () {
    var newWaypoint = routingControl.getWaypoints()[0].latLng;          //Captura
    var newLat = mi_posicino_lat;
    var newLng = mi_posicino_lng;
    routingControl.setWaypoints([
                                 L.latLng(newLat, newLng),              //Nuevo origen
                                 routingControl.options.waypoints[1]    //Mismo destino
                               ]);
    //Pone el valor del tiempo y distancia que se tardaria en la etiquita tiempo <div>
    
}, 1000);

</script>
</body>
</html>